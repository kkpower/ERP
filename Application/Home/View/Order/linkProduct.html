<script>
	$('#34').parents('li').addClass('nav-active')
	$('#34').parents('li').addClass('nav-expanded')
</script>
<link rel="stylesheet" type="text/css" href="__ROOT__/Public/FirstEdition/assets/shu/boot/bootstrap-select.css" />
<style type="text/css">
		.bootstrap-select.btn-group .dropdown-toggle .filter-option {
		padding-left: 5px;
		padding-top: 3px;
		color: #666;
	}
	
	.bootstrap-select {
		/*width: 50% !important;*/
	}
	
	.bootstrap-select>button {
		height: 100%;
		line-height: 100%;
	}
	
	.bootstrap-select>button:active {
		background: #fff !important;
	}
	
	.bootstrap-select>button:hover {
		background: #fff !important;
	}
	
	.bootstrap-select>button:focus {
		background: #fff !important;
	}
	
	#details_body .col-md-6 {
		padding-left: 0;
	}
	
	#details_body .col-md-12 {
		padding-left: 0;
	}
	
	#details_img {
		text-align: center;
	}
	
	#details_img>div {
		display: inline-block;
		width: 45%;
		position: relative;
		margin: 0 2% 2%;
	}
	
	#details_img img {
		width: 100%;
	}
	
	#details_img p {
		color: #333;
		line-height: 18px;
	}
	
	#details_img span {
		position: absolute;
		top: 0;
		right: 0;
		line-height: 16px;
		text-align: center;
		font-size: 16px;
		color: red;
		font-weight: bold;
	}
	
	#details_tbody input {
		border: 0;
	}
	
	#details_tbody td {
		line-height: 34px;
		padding: 0;
	}
	
	#details_tbody img {
		width: 34px;
		margin: 4px;
	}
	
	#product_list tr td:nth-child(5) {
		width: 100px;
	}
	
	#details_tbody tr td:nth-child(4) {
		width: 100px;
	}
	#image{  
            position: absolute;  
            display: none; 
            z-index: 9999; 
            border: 1px solid #ccc;
        }  
</style>

<div class="row">
	<div class="col-md-12">
		<section class="panel">
			<header class="panel-heading">
				<!--<a style="display: inline-block;float: left;font-size: 18px;line-height: 20px;margin-right: 15px;" href="{:U('Order/mySales')}">
					<i class="fa fa-home"></i>
				</a>-->
				<h2 class="panel-title">{$Think.lang.add_links}</h2>
			</header>
			<div class="panel-body">
				<img id="image" src=""/>
				<div>
					<div id="node_message" style="position: fixed;top: 50%;left: 50%;display: none;background: #888;min-width:300px;margin-left: -150px;margin-top:-15px;border-radius: 8px;text-align: center;font-size: 16px;padding: 12px 20px;color: #fff;z-index: 1200;"></div>
					<p id="status_id" style="display: none;">{$info.status_id}</p>
					<input type="hidden" id="ebay_id" value="{$info.ebay_id}" />

					<div class="col-md-12">
						<div class="input-group">
							<span class="input-group-addon">Import from</span>
							<input id="input4" type="text" name="recipient_first_name" class="form-control" value="{$info.type}" placeholder="" readonly="readonly">
						</div>
					</div>
					<div class="col-md-12" style="padding-top: 12px;">
						<div class="input-group">
							<span class="input-group-addon">SKU</span>
							<input type="hidden" id="input66" value="{$info.sku_id}"/>
							<input id="input6" style="cursor: pointer;" onclick="window.open('https://{$href}')" name="buyer_phone" type="text" class="form-control" value="{$info.item_number}" placeholder="" readonly="readonly">
						</div>
					</div>
					<div class="col-md-12" style="padding-top: 12px;">
						<div class="input-group">
							<span class="input-group-addon">Var</span>
							<input style="cursor: pointer;" onclick="window.open('https://{$href}')" name="buyer_phone" type="text" class="form-control" value="{$info.var}" placeholder="" readonly="readonly">
						</div>
					</div>
					<div class="col-md-12" style="padding-top: 12px;">
						<div class="input-group">
							<span class="input-group-addon">Item</span>
							<input style="cursor: pointer;" onclick="window.open('https://{$href}')" name="buyer_phone" type="text" class="form-control" value="{$info.external_title}" placeholder="" readonly="readonly">
						</div>
					</div>

					<div class="col-md-12" id="order_products">
						<form id="form1">
							<table class="table table-hover table-bordered table-striped" style="margin-top: 12px;border-collapse: collapse;text-align: center;">
								<thead>
									<tr>
										<th style="text-align: center;">{$Think.lang.image}</th>
										<th style="text-align: center;">{$Think.lang.product_code}</th>
										<th style="text-align: center;">{$Think.lang.Productname}</th>
										<th style="text-align: center;">{$Think.lang.Number}</th>
										<th style="text-align: center;width: 50px;">{$Think.lang.Operation}</th>
									</tr>
								</thead>
								<tbody id="details_tbody">
									<volist name="list" id="vo">
										<tr id="tr_{$vo.pid}">
											<td>
												<img src="__ROOT__{$vo.thumb}" alt="" onmouseover="displayImg(this)" onmouseout="vanishImg()" onmousemove="displayImg(this)">
											</td>
											<td>
												<if condition="$vo.bclass neq null">
													<a target="_blank" href="{:U('Product/homeProduct','','')}/pid/{$vo.pid}">{$vo.bclass}.{$vo.sclass}.{$vo.num}</a>
												</if>
											</td>
											<td>
												<a target="_blank" href="{:U('Product/homeProduct','','')}/pid/{$vo.pid}">{$vo.namezh}</a>
											</td>
											<td><input class="form-control" id="input_{$vo.pid}" name="num[]" type="text" value="{$vo.number}"></td>
											<td>
												<div class="btn btn-danger btn-xs" title="{$Think.lang.Delete}" onclick="delete_pr('{$vo.pid}')"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span></div>
											</td>
										</tr>
									</volist>
								</tbody>
							</table>
						</form>
					</div>
					<br style="clear: both;" />
					<button id="Add" class="btn btn-primary" onclick="add_pr()" style="margin-left: 15px;">{$Think.lang.related_products}</button>
					<button id="Packaging" class="btn btn-primary" onclick="save_list()">{$Think.lang.Save}</button>
				</div>
			</div>
		</section>
	</div>
</div>

<div id="node_modal" class="modal fade  bs-example-modal-lg" tabindex="-1" role="dialog">
	<div style="width: 90%;" class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title">
						{$Think.lang.title}:<span style="color: red;">{$info.var}</span>
					</h4>
			</div>
			<div class="modal-body" style="line-height: 34px;">
				<div class="row" style="margin-left: 0;margin-right: 0;">
					<input type="hidden" value="{$info.var}" name="sku" readonly="readonly" class="form-control" />
					<div class="col-md-5" style="padding-left: 0;padding-bottom: 15px;">
						<div class="input-group">
							<span class="input-group-addon">{$Think.lang.product_keywords}</span>
							<input type="text" id="pr_keyword" class="form-control" value="{$keywords}" />
							<span class="input-group-addon btn btn-success" onclick="search_pr()" style="white-space: nowrap;">{$Think.lang.Search}</span>
						</div>
					</div>
					<button class="btn btn-primary" style="float: right;" onclick="add_all()">{$Think.lang.add_all}</button>
					<div class="col-md-3" style="float: left;">
						<div class="input-group">
							<span class="input-group-addon">{$Think.lang.Display_quantity}</span>
							<select id="select_num" class="form-control">
								<option value="15">15</option>
								<option value="30">30</option>
								<option value="50">50</option>
								<option value="100">100</option>
								<option value="all">{$Think.lang.All}</option>
							</select>
						</div>
					</div>
					<br style="clear: both;" />
					<table class="table table-hover table-bordered table-striped" style="border-collapse: collapse;text-align: center;">
						<thead>
							<tr>
								<th style="text-align: center;">{$Think.lang.image}</th>
								<th style="text-align: center;">{$Think.lang.product_code}</th>
								<th style="text-align: center;">{$Think.lang.Productname}</th>
								<th style="text-align: center;">{$Think.lang.select}</th>
								<th style="text-align: center;">{$Think.lang.Number}</th>
								<th style="text-align: center;">{$Think.lang.Operation}</th>
							</tr>
						</thead>
						<tbody id="product_list">
							<volist name="product" id="vo">
								<tr id="tr_{$vo.pid}">
									<td>
										<img style="width: 34px;" src="__ROOT__{$vo.thumb}" alt="" onmouseover="displayImg(this)" onmouseout="vanishImg()" onmousemove="displayImg(this)" >
									</td>
									<td>
										<a target="_blank" href="{:U('Product/homeProduct','','')}/pid/{$vo.pid}">{$vo.bclassc_number}.{$vo.sclassc_number}.{$vo.snumber_number}</a>
									</td>
									<td>
										<a target="_blank" href="{:U('Product/homeProduct','','')}/pid/{$vo.pid}">{$vo.namezh}</a>
									</td>
									<td>
										<input type="checkbox" name="check" id="check_{$vo.pid}" value="{$vo.pid}" style="width: 25px;height: 25px;">
									</td>
									<td><input class="form-control" id="input1_{$vo.pid}" name="num[]" type="text" value="1" onblur="check_change(this)"></td>
									<td><button class="btn btn-primary btn-xs" onclick="one_add('{$vo.pid}')">{$Think.lang.add}</button></td>
								</tr>
							</volist>
						</tbody>
					</table>
				</div>
			</div>
			<div class="modal-footer">
				<!--<button class="btn btn-primary" id="add_pr" onclick="confirm_add()" type="submit">确认</button>-->
				<button type="button" class="btn btn-default" data-dismiss="modal">{$Think.lang.Close}</button>
			</div>
		</div>

	</div>
	<!-- /.modal-content -->
</div>
<script src="__ROOT__/Public/FirstEdition/assets/shu/boot/bootstrap-select.js"></script>
<script>
	var arr = [];
	var pid_arr = [];
	$(document).ready(function() {
		var tr = $('#details_tbody').find('tr');
		for(var i = 0; i < tr.length; i++) {
			arr.push(tr[i].id.split('_')[1]);
			pid_arr.push(tr[i].id.split('_')[1]);
		}
		console.log(arr);
	});
	//添加产品，生成随机sku
	function add_pr() {
		$('#node_modal').modal('toggle');
	}
	//保存信息
	function save_list() {
		var form_arr = $('#form1').serializeArray();
		var num_arr = [];
		for(var i = 0; i < form_arr.length; i++) {
			num_arr.push(form_arr[i].value);
		}
		console.log(arr);
		console.log(num_arr);
		$.ajax({
			url: "{:U('Order/addLinkProduct')}",
			type: "post",
			data: {
				sku_id: $('#input66').val(),
				supplier_pr_id: arr,
				num: num_arr
			},
			dataType: "json",
			async: true,
			success: function(data) {
				console.log(data);
				if(t) {
					clearTimeout(t)
				};
				$('#node_message').html('{$Think.lang.Savesuccessfully}');
				node_message.style.display = 'block';
				var t = setTimeout("node_message.style.display='none';location.reload()", 2000);
			}
		});
	}

	//添加产品
	function skuInfo() {
		$.ajax({
			url: "{:U('Order/skuInfo')}", //通过页面元素的ID来获取设备ID
			type: "post", //选择传值方式
			data: {
				sku: $('#input66').val()
			},
			dataType: "JSON",
			success: function(data) {
				for(var i = 0; i < data.length; i++) {
					$('#input_' + data[i].pid).val(data[i].number)
				}

			}
		})
	}

	//提交添加
	function confirm_add() {
		var arr1 = $('#form').serializeArray();
		for(var i = 0; i < arr1.length; i++) {
			arr.push(arr1[i].value);
		}
		console.log(arr);
		arr = Array.from(new Set(arr));
		arr.sort();
		$.ajax({
			url: "{:U('Order/getAjaxProduct')}", //通过页面元素的ID来获取设备ID
			type: "post", //选择传值方式
			data: {
				pid: arr
			},
			dataType: "JSON",
			success: function(data) {
				$('#details_tbody').empty();
				console.log(data)
				var str = ""
				for(var i = 0; i < data.length; i++) {
					str += '<tr id="tr_' + data[i].pid + '">' +
						'<td><img src="__ROOT__' + data[i].thumb + '"></td>' +
						'<td><a target="_blank" href="' + "{:U('Product/homeProduct','','')}/pid/" + data[i].pid + '">' + data[i].bclassc_number + '.' + data[i].sclassc_number + '.' + data[i].snumber_number + '</a></td>' +
						'<td><a target="_blank" href="' + "{:U('Product/homeProduct','','')}/pid/" + data[i].pid + '">' + data[i].namezh + '</a></td>' +
						'<td><input class="form-control" id="input_' + data[i].pid + '" name="num[]" type="text" value="1"></td>' +
						'<td><div class="btn btn-danger btn-xs" title="{$Think.lang.Delete}" onclick="delete_pr(' + data[i].pid + ')"><span class="glyphicon glyphicon-trash" aria-hidden="true"></span></div></td>' +
						'</tr>'
				}
				$('#details_tbody').append(str);
				skuInfo();
				$('#node_modal').modal('toggle');
			}
		})
	}

	//产品关键词搜索
	$('#pr_keyword').on('keyup', function(event) {
		if(event.keyCode == '13') {
			search_pr()
		}
	})

	$('#select_num').on('change', function() {
		search_pr()
	})

	//搜索
	function search_pr() {
		$.ajax({
			url: "{:U('Order/titleInfo')}", //通过页面元素的ID来获取设备ID
			type: "post", //选择传值方式
			data: {
				search: $('#pr_keyword').val(),
				limit: $('#select_num').val(),
				pid: pid_arr
			},
			dataType: "JSON",
			success: function(data) {
				console.log(data)
				$('#product_list').empty();
				var str = "";
				for(var i = 0; i < data.length; i++) {
					str += '<tr id="tr_' + data[i].pid + '">' +
						'<td><img style="width: 34px;" src="__ROOT__' + data[i].thumb + '" onmouseover="displayImg(this)" onmouseout="vanishImg()" onmousemove="displayImg(this)"></td>' +
						'<td><a target="_blank" href="' + "{:U('Product/homeProduct','','')}/pid/" + data[i].pid + '">' + data[i].bclassc_number + '.' + data[i].sclassc_number + '.' + data[i].snumber_number + '</a></td>' +
						'<td><a target="_blank" href="' + "{:U('Product/homeProduct','','')}/pid/" + data[i].pid + '">' + data[i].namezh + '</a></td>' +
						'<td><input type="checkbox" name="check" id="check_' + data[i].pid + '" value="' + data[i].pid + '" style="width: 25px;height: 25px;"></td>' +
						'<td><input class="form-control" id="input1_' + data[i].pid + '" name="num[]" type="text" value="1" onblur="check_change(this)"></td>' +
						'<td><button class="btn btn-primary btn-xs" onclick="one_add(' + data[i].pid + ')">{$Think.lang.add}</button></td>' +
						'</tr>'
				}
				$('#product_list').append(str);
			}
		})
	}
	//添加一条产品
	function one_add(pid) {
		$.ajax({
			url: "{:U('Order/addProduct')}", //通过页面元素的ID来获取设备ID
			type: "post", //选择传值方式
			data: {
				sku_id: $('#input66').val(),
				supplier_pr_id: pid,
				num: Number($('#input1_' + pid).val()),
				ebay_id: $('#ebay_id').val()
			},
			dataType: "JSON",
			success: function(data) {
				console.log(data);
				if(t) {
					clearTimeout(t)
				};
				$('#node_message').html('{$Think.lang.Savesuccessfully}');
				node_message.style.display = 'block';
				var t = setTimeout("node_message.style.display='none';location.reload()", 1000);
			}
		})
	}
	//添加多条产品
	function add_all() {
		var all_arr = [],
			input_arr = [];
		var check = $('input[name="check"]');
		console.log(check);
		for(var i = 0, c; c = check[i++];) {
			if(c.checked) {
				var pid1 = c.id.split('_')[1];
				all_arr.push(pid1);
			}
		}
		if(all_arr.length == 0) {
			if(t) {
				clearTimeout(t)
			};
			$('#node_message').html('{$Think.lang.Pleaseselectaproduct}');
			node_message.style.display = 'block';
			var t = setTimeout("node_message.style.display='none';", 2000);
			return false;
		}
		console.log(all_arr)
		for(var i = 0; i < all_arr.length; i++) {
			//			console.log()
			var num1 = $('#input1_' + all_arr[i]).val();
			input_arr.push(num1);
		}
		console.log(input_arr)
		$.ajax({
			url: "{:U('Order/addAllProduct')}", //通过页面元素的ID来获取设备ID
			type: "post", //选择传值方式
			data: {
				sku_id: $('#input66').val(),
				supplier_pr_id: all_arr,
				num: input_arr,
				ebay_id: $('#ebay_id').val()
			},
			dataType: "JSON",
			success: function(data) {
				console.log(data);
				if(t) {
					clearTimeout(t)
				};
				$('#node_message').html('{$Think.lang.Savesuccessfully}');
				node_message.style.display = 'block';
				var t = setTimeout("node_message.style.display='none';location.reload()", 1000);
			}
		})
	}
	//删除产品
	function delete_pr(pid) {
		var r = confirm('{$Think.lang.Confirmdelete}');
		if(r == true) {
			$.ajax({
				url: "{:U('Order/delLinkProduct')}", //通过页面元素的ID来获取设备ID
				type: "post", //选择传值方式
				data: {
					pid: pid,
					sku_id: $('#input66').val()
				},
				dataType: "JSON",
				success: function(data) {
					console.log(data)
					$('#tr_' + pid).remove();
					var index = arr.indexOf(String(pid));
					arr.splice(index, 1);
					console.log(arr);
				}
			})
		} else {
			return false;
		}

	}
	
	     //显示图片  
        function displayImg(obj) {  
            var img = document.getElementById("image");  
  
            //var x = event.clientX + document.body.scrollLeft + 20;  
            //var y = event.clientY + document.body.scrollTop - 5;   
           var e = event || window.event;
           var scrollX = document.documentElement.scrollLeft || document.body.scrollLeft;
           var scrollY = document.documentElement.scrollTop || document.body.scrollTop;
           var x = e.pageX || e.clientX + scrollX;
           var y = e.pageY || e.clientY + scrollY; 
            img.style.left = x -216 + "px";  
            img.style.top = y - 130 + "px";  
            img.style.display = "block"; 
            img.src = obj.src;
        }  
   //图片消失
    function vanishImg(){
         var img = document.getElementById('image');
         img.style.display = "none";
    }
    //检测输入框变化选择框选中
    function check_change(obj){
    	if(obj.value !='1'){
    		$(obj).parents('tr').find('input[name="check"]').attr('checked',true);
	 	}
    }
</script>